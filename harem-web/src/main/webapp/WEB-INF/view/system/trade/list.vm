<link href="$!{rc.contextPath}/resources/zui/lib/datetimepicker/datetimepicker.min.css" rel="stylesheet">
<script src="$!{rc.contextPath}/resources/zui/lib/datetimepicker/datetimepicker.min.js" type="text/javascript"></script>
<link rel="stylesheet" href="/resources/css/style.css"/>
<h1>交易列表</h1>
<div>
    <form class="form-signin" id="tradeListForm" name="tradeListForm" action="/tradeManage/list" method="GET" role="form">
        <div class="inputGroup whole">
                <div class="input-group inpSingle">
                    <span class="input-group-btn">
                        <button class="btn btn-default" type="button">交易号</button>
                    </span>
                    <input type="text" class="form-control" name="tradNO" value="$!tradeListQuery.tradNO">
                </div>
                <div class="input-group inpSingle">
                    <span class="input-group-btn">
                        <button class="btn btn-default" type="button">手机号</button>
                    </span>
                    <input type="text" class="form-control" name="phone" value="$!tradeListQuery.phone">
                </div>
                <div class="input-group inpSingle">
                    <span class="input-group-btn">
                        <button class="btn btn-default" type="button">会员名</button>
                    </span>
                    <input type="text" class="form-control" name="userName" value="$!tradeListQuery.userName">
                </div>
                <div class="input-group inpSingle">
                    <span class="input-group-btn">
                        <button class="btn btn-default" type="button">终端编号</button>
                    </span>
                    <input type="text" class="form-control" name="terminalName" value="$!tradeListQuery.terminalName">
                </div>
                <div class="input-group inpSingle">
                    <span class="input-group-btn">
                        <button class="btn btn-default" type="button">交易时间</button>
                    </span>
                    <input type="text" class='form-control form-date' placeholder='开始日期：yyyy-MM-dd' readonly name="beginDate" value="$!tradeListQuery.beginDate">
                    <span class="input-group-addon fix-border fix-padding">至</span>
                    <input type="text" class='form-control form-date' placeholder='结束日期：yyyy-MM-dd' readonly name="endDate" value="$!tradeListQuery.endDate">
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">查询</button>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn">导出</button>
                </div>
        </div>

        <div class="tableGroup whole">
            <table class="table table-hover">
                <thead>
                <tr>
                    <th>#</th>
                    <th>交易编号</th>
                    <th>会员姓名</th>
                    <th>手机号</th>
                    <th>应付金额</th>
                    <th>实付金额</th>
                    <th>优惠金额</th>
                    <th>使用积分</th>
                    <th>赠送积分</th>
                    <th>剩余积分</th>
                    <th>交易状态</th>
                    <th>交易时间</th>
                    <th>终端</th>
                    <th>收银员</th>
                    <th>备注</th>
                    <th>查看</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody>
                    #foreach($trade in $tradeList)
                    <tr>
                        <td>$!velocityCount</td>
                        <td>$!trade.tradNO</td>
                        <td>$!trade.userName</td>
                        <td>$!trade.phone</td>
                        <td>$!trade.shouldMoney</td>
                        <td>$!trade.tradeMoney</td>
                        <td>$!trade.reduceMoney</td>
                        <td>$!trade.usePoint</td>
                        <td>$!trade.sendPoint</td>
                        <td>$!trade.point</td>
                        <td>$!trade.tradeStatus</td>
                        <td>$utilDate.dateToString($!trade.tradeTime,"yyyy-MM-dd HH:mm:ss")</td>
                        <td>$!trade.terminalName</td>
                        <td>$!trade.cashierName</td>
                        <td>$!trade.remark</td>
                        <td><a href="javascript:getOrder('$!trade.id');">订单详情</a></td>
                        <td><button type="button" class="btn btn-lg btn-primary addRefund" data-toggle="modal" data-target="#refundModal" tradeNO="$!trade.tradNO">发起退款</button></td>
                    </tr>
                    #end
                </tbody>
            </table>
        </div>
    #*分页*#
    #parse("/page.vm")
    #pageStyle("tradeListForm")
    </form>

    <!-- 退款模态框 -->

    <div class="modal fade" id="refundModal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">关闭</span></button>
                    <h4 class="modal-title">对话框标题</h4>
                </div>
                <div class="modal-body">
                    <div>
                        说明
                        1 作为查看页面时文本框不可编辑
                        2 点击退款弹出确认退款提示
                        3 如果退款订单产生的积分已经使用，使用的部分需要折算成人民币在退款中扣除
                        4 需返还积分=该笔交易赠送的总积分 -（消费金额-退款金额）*消费积分兑换规则
                        5 可返还积分=该笔交易赠送的积分余量
                    </div>
                    <form class="form-signin" id="refundAddForm" action="/refundManage/add" method="POST" role="form">
                        <div class="form-group">
                            <div>
                                <label for="refundMoney">退款金额</label>
                                <input id="refundMoney" type="text" class="form-control refundMoney" placeholder="退款金额" name="refundMoney" value="">
                            </div>
                            <div>
                                <label for="shouldRefundPoint">需返还积分</label>
                                <input type="text" class="form-control shouldRefundPoint" placeholder="需返还积分" name="shouldRefundPoint" value="" readonly>
                            </div>
                            <div>
                                <label for="availablePoint">可返还积分</label>
                                <input type="text" class="form-control availablePoint" placeholder="可返还积分" name="availablePoint" value="" readonly>
                            </div>
                            <div>
                                <label for="deductMoneyOffsetPoint">超出积分扣现</label>
                                <input type="text" class="form-control deductMoneyOffsetPoint" placeholder="超出积分扣现" name="deductMoneyOffsetPoint" value="" readonly>
                            </div>
                            <div>
                                <label for="factRefundMoney">实际退款金额</label>
                                <input type="text" class="form-control factRefundMoney" placeholder="实际退款金额" name="factRefundMoney" value="" readonly>
                            </div>
                            <div>
                                <label for="operatorName">操作员</label>
                                <input type="text" class="form-control operatorName" placeholder="操作员" name="operatorName" value="" readonly>
                            </div>
                            <div>
                                <label for="remark">备注</label>
                                <input type="text" class="form-control remark" placeholder="备注" name="remark" value="" >
                            </div>


                            <button id="btnSubmit" class="btn btn-lg btn-primary btn-block" type="button">提交</button>
                        </div>
                    </form>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary">确定</button>
                </div>

            </div>
        </div>
    </div>

</div>
<script>
    $(".form-date").datetimepicker(
            {
                language:  "zh-CN",
                weekStart: 1,
                todayBtn:  1,
                autoclose: 1,
                todayHighlight: 1,
                startView: 2,
                minView: 2,
                forceParse: 0,
                format: "yyyy-mm-dd"
            });


    function getOrder(id)
    {
        window.open("/orderManage/"+id, "_blank");
    }

    $(function(){
        $('.addRefund').click(function(){
            $.post('/refundManage/add/'+$(this).attr('tradeNO'),function(data){
                if(data&&data.status==200){
                    data = data.data;
                    $('.orderDetail').add()
                }else{
                    alert(data.status == 403 ? data.message:'请求失败');
                }

            });
        })
        $("#refundMoney").blur( function () {
            $('#btnSubmit').prop("disabled",true);
            $.post('/refundManage/refund',{refundMoney:$(this).val()},function(data){
                if(data&&data.status==200){
                    data = data.data;
                    $('.shouldRefundPoint').val(data.shouldRefundPoint);
                    $('.availablePoint').val(data.availablePoint);
                    $('.deductMoneyOffsetPoint').val(data.deductMoneyOffsetPoint);
                    $('.factRefundMoney').val(data.factRefundMoney);
                    $('.operatorName').val(data.operatorName);
                    $('#btnSubmit').prop("disabled",false);
                }else{
                    alert('请求失败');
                }

            });

        });
        $('#btnSubmit').click(function(){
            $.post('/refundManage/add',$("#refundAddForm").serialize(),function(data){
                if(data.status==200){
                    alert('提交成功');
                    window.location.href = window.location.href;
                }else{
                    alert('提交失败');
                }
            });
        });

    });
</script>