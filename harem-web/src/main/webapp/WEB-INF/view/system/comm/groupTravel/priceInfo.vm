<link href="$utilWebconfig.getStaticResourcesPath()/resources/zui/lib/datetimepicker/datetimepicker.min.css" rel="stylesheet">
<script src="$utilWebconfig.getStaticResourcesPath()/resources/zui/lib/datetimepicker/datetimepicker.min.js" type="text/javascript"></script>
<script src="$utilWebconfig.getStaticResourcesPath()/resources/js/CalendarUtils.js" type="text/javascript"></script>
<div>
	<ul class="nav nav-tabs">
		<li class="active">
          <a href="#money" data-toggle="tab">tab</a>
        </li>
     </ul>
    <div class="tab-content">
        <div class="tab-pane in active" id="money">
			<div>
				<div>可选出发日：</div>
				<div>
					<input type="text" class='form-control form-date' placeholder='开始日期：yyyy-MM-dd' readonly name="startDate" id="startDate">
                    <span class="input-group-addon fix-border fix-padding">至</span>
                    <input type="text" class='form-control form-date' placeholder='结束日期：yyyy-MM-dd' readonly name="endDate" id="endDate">
					<button class="btn btn-primary addTC">添加新套餐</button>
                </div>
            </div>
			<div>
				<div>套餐设置：</div>
				<div>
					<ul id="tc_tab" class="nav nav-tabs">
                    </ul>
					<div id="tc_page" class="tab-content">
                    </div> 
				</div>
            </div>
			<div>
				<div>提前报名天数：</div>
				<div>
					<input type="text" class="form-control day-limit">
				</div>
            </div>
		</div>
    </div>
</div>
<button class='btn btn-primary save'>保存</button>
<script type="text/javascript">
	// 日期输入框初始化
	$(".form-date").datetimepicker(
            {
                language:  "zh-CN",
                weekStart: 1,
                todayBtn:  1,
                autoclose: 1,
                todayHighlight: 1,
                startView: 2,
                minView: 2,
                forceParse: 0,
                format: "yyyy-mm-dd"
            });
	$(".form-datetime").datetimepicker(
			{
				language:  "zh-CN",
                weekStart: 1,
                todayBtn:  1,
                autoclose: 1,
                todayHighlight: 1,
                startView: 2,
                forceParse: 0,
                showMeridian: 1,
                format: "yyyy-mm-dd hh:ii"
            });
	var WEEK = {
		0:"周日",
		1:"周一",
		2:"周二",
		3:"周三",
		4:"周四",
		5:"周五",
		6:"周六"
	};
	$(".addTC").click(function(){
		curTcId = curTcId + 1;
		var tcTab = createTcTab(curTcId);
		$("#tc_tab").append(tcTab);
		var startDate = new Date($("#startDate").val());
		var endDate = new Date($("#endDate").val());
		var tcTabContent = createTcContent(curTcId,startDate,endDate);
		$("#tc_page").append(tcTabContent);
		$("#tc_"+curTcId).find(".tab-page a").eq(0).click();
		$("#tc_tab_"+curTcId+"_a").click();
	})
	// 初始化
	var curTcId;
	$(function() {
		curTcId = $("#tc_tab li").length;
	});
	function createTcTab(id) {
		var tcTab = $("<li class='tab-page tc-tab' rId='"+id+"' id='tc_"+id+"_tab'/>");
		var tabA = $("<a href='#tc_"+id+"' data-toggle='tab' id='tc_tab_"+id+"_a'>套餐"+id+"&nbsp;&nbsp;</a>");
		var remove = $("<i class='icon icon-remove' tcId='"+id+"'/>");
		remove.click(function() {
			var id = $(this).attr("tcId");
			var prev = $("#tc_"+id+"_tab").prev();
			var next = $("#tc_"+id+"_tab").next();
			if(prev.length != 0) {
				prev.children("a").click();
			} else if(next.length != 0) {
				next.children("a").click();
			}
			$("#tc_"+id+"_tab").remove();
			$("#tc_"+id).remove();
		});
		return tcTab.append(tabA).append(remove);
	}
	function createTcContent(id,startDate,endDate) {
		var pane = $("<div class='tab-pane in' id='tc_"+id+"'/>")
		var table = $("<table class='table'/>");
		var td = $("<td/>");
		var tcName = $("<span>套餐名称：*<input type='text' id='tc_"+id+"_name' class='form-control' placeholder='请输入套餐名称'></span>")
		td.append(tcName);
		table.append($("<tr/>").append(td));
		var dateJson = CalendarUtils.getMonthTree(startDate,endDate);
		var dateTab = createDateTab(id,dateJson,startDate,endDate);
		var dateTabContent = createDateContent(id,dateJson,startDate,endDate);
		pane.append(table.append($("<tr/>").append($("<td/>").append(dateTab).append(dateTabContent))));
		return pane;
	}
	function createDateTab(id,dateJson,startDate,endDate) {
		var tab = $("<ul class='nav nav-tabs'/>");
		for(i in dateJson) {
			var tcTab = $("<li class='tab-page tc-"+id+"-month' rId='"+i+"' id='tc_"+id+"_month_"+i+"_tab'/>");
			var month = CalendarUtils.getFormat(new Date(parseInt(i)),"yyyy年MM月");
			var tabA = $("<a href='#tc_"+id+"_month_"+i+"' data-toggle='tab'>"+month+"</a>");
			tab.append(tcTab.append(tabA));
		}
		var batch = $("<button class='btn btn-primary'>批量录入</button>");
		batch.click(function(){
			layer.open({
                type: 2,
                area: ['700px', '530px'],
                fix: tue,
                maxmin: true,
                content: 'test/iframe.html'
            });
		});
		tab.append($("<li>").append(batch));
		return tab;
	}
	function createDateContent(id,dateJson,startDate,endDate) {
		var content = $("<div class='tab-content'/>");
		for(i in dateJson) {
			var tcTab = $("<div class='tab-pane in' id='tc_"+id+"_month_"+i+"'/>");
			var table = $("<table class='table'/>");
			var list = dateJson[i];
			var tr;
			for(j in list) {
				if(j % 2 == 0) {
					tr = $("<tr/>");
					table.append(tr);
				}
				var time = new Date(list[j]);
				var d =  CalendarUtils.getFormat(time ,"dd日 " + WEEK[time.getDay()]);
				// 扩展点
				var td = $("<td class='tc-"+id+"-month-"+i+"-day' rId='"+list[j]+"'></td>");
				var day_id = "tc_"+id+"_month_"+i+"_day_"+list[j];
				var div_date = $("<div>"+d+"</div>");
				td.append(div_date);
				var group_1 = $("<div class='input-group'/>")
				group_1.append("<span class='input-group-addon'>￥成人价：</span>");
				group_1.append("<input type='text' class='form-control' id='"+day_id+"_11' placeholder='请输入成人价'>"); 
				group_1.append("<span class='input-group-addon'>库存：</span>");
				group_1.append("<input type='text' class='form-control' id='"+day_id+"_12' placeholder='请输入库存'>"); 
				group_1.append("<span class='input-group-addon'>会员优惠：</span>");
				group_1.append("<input type='text' class='form-control' id='"+day_id+"_13' placeholder='请输入会员优惠'>"); 
				td.append(group_1);
				var group_2 = $("<div class='input-group'/>")
				group_2.append("<span class='input-group-addon'>￥儿童价（0-2）：</span>");
				group_2.append("<input type='text' class='form-control' id='"+day_id+"_21' placeholder='请输入儿童价'>"); 
				group_2.append("<span class='input-group-addon'>库存：</span>");
				group_2.append("<input type='text' class='form-control' id='"+day_id+"_22' placeholder='请输入库存'>"); 
				group_2.append("<span class='input-group-addon'>会员优惠：</span>");
				group_2.append("<input type='text' class='form-control' id='"+day_id+"_23' placeholder='请输入会员优惠'>"); 
				td.append(group_2);
				var group_3 = $("<div class='input-group'/>")
				group_3.append("<span class='input-group-addon'>￥儿童价（2-12）：</span>");
				group_3.append("<input type='text' class='form-control' id='"+day_id+"_31' placeholder='请输入儿童价'>"); 
				group_3.append("<span class='input-group-addon'>库存：</span>");
				group_3.append("<input type='text' class='form-control' id='"+day_id+"_32' placeholder='请输入库存'>"); 
				group_3.append("<span class='input-group-addon'>会员优惠：</span>");
				group_3.append("<input type='text' class='form-control' id='"+day_id+"_33' placeholder='请输入会员优惠'>"); 
				td.append(group_3);
				var group_4 = $("<div class='input-group'/>")
				group_4.append("<span class='input-group-addon'>￥单房差：</span>");
				group_4.append("<input type='text' class='form-control' id='"+day_id+"_41' placeholder='请输入单房差'>"); 
				td.append(group_4);
				tr.append(td);
			}
			content.append(tcTab.append(table));
		}
		return content;
	}
	
	// 获取价格信息
	function getPriceInfo() {
		var tcs = [];
		$(".tc-tab").each(function(){
			var tcId = $(this).attr("rId");
			var months = [];
			$(".tc-"+tcId+"-month").each(function(){
				var mId = $(this).attr("rId");
				var days = [];
				$(".tc-"+tcId+"-month-"+mId+"-day").each(function(){
					var dId = $(this).attr("rId");
					var day_id = "tc_"+tcId+"_month_"+mId+"_day_"+dId;
					var adult = {
						price:$("#"+day_id+"_11").val(),
						stock:$("#"+day_id+"_12").val(),
						discount:$("#"+day_id+"_13").val()
					};
					var children_0_2 = {
						price:$("#"+day_id+"_21").val(),
						stock:$("#"+day_id+"_22").val(),
						discount:$("#"+day_id+"_23").val()
					};
					var children_2_12 = {
						price:$("#"+day_id+"_31").val(),
						stock:$("#"+day_id+"_32").val(),
						discount:$("#"+day_id+"_33").val()
					};
					var srd = $("#"+day_id+"_41").val();
					days.push({
						id:dId,
						adult:adult,
						children_0_2:children_0_2,
						children_2_12:children_2_12,
						srd:srd
					});
				});
				months.push({id:mId,days:days});
			});
			tcs.push({id:tcId,months:months});
		});
		var result = {tcs:tcs,limit:$(".day-limit").val()};
		alert(JSON.stringify(result));
	}
	$(".save").click(getPriceInfo);
</script>