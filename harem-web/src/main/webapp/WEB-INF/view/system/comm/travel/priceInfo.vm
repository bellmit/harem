<!--
<link href="$!{utilWebconfig.getStaticResourcesPath()}/resources/zui/lib/datetimepicker/datetimepicker.min.css" rel="stylesheet">
<script src="$!{utilWebconfig.getStaticResourcesPath()}/resources/zui/lib/datetimepicker/datetimepicker.min.js" type="text/javascript"></script>
<script src="$!{utilWebconfig.getStaticResourcesPath()}/resources/js/calendar-tool.js" type="text/javascript"></script>
-->
<div>
	<div>
		<div>可选出发日：</div>
		<div>
			<input type="text" class='form-control form-date' placeholder='开始日期：yyyy-MM-dd' readonly id="startTime" value="$!{product.priceInfo.startTime}">
            <span class="input-group-addon fix-border fix-padding">至</span>
            <input type="text" class='form-control form-date' placeholder='结束日期：yyyy-MM-dd' readonly id="endTime" value="$!{product.priceInfo.endTime}">
			<button class="btn btn-primary setTime" #if($product) style="display:none;" #end>确定</button>
        </div>
    </div>
	<div class="tc-main" #if(!$product) style="display:none;" #end>
		<div>套餐设置：<button class="btn btn-primary addTC">添加新套餐</button></div>
		<div>
			<ul id="tc_tab" class="nav nav-tabs">
				#foreach($tc in $!{product.priceInfo.tcs})
				<li class="tab-page tc-tab #if(${velocityCount}==1) active #end" rId="${velocityCount}" id="tc_${velocityCount}_tab">
					<a href="#tc_${velocityCount}" data-toggle="tab" id="tc_tab_${velocityCount}_a">套餐${velocityCount}</a>
					<i class="icon icon-remove tc-del" tc-id="${velocityCount}"></i>
				</li>
				#end
            </ul>
			<div id="tc_page" class="tab-content">
				#foreach($tc in ${product.priceInfo.tcs})
				#set($tcId = $velocityCount)
				<div class="tab-pane in #if(${velocityCount}==1) active #end" id="tc_${velocityCount}">
					<input type="hidden" id="tc_${velocityCount}_startTime" value="$!{tc.startTime}">
					<input type="hidden" id="tc_${velocityCount}_endTime" value="$!{tc.endTime}">
					<table class="table">
						<tbody>
							<tr>
								<td>
									<div>套餐名称：*<input type="text" id="tc_${velocityCount}_name" class="form-control" placeholder="请输入套餐名称" value="$!{tc.name}"></div>
								</td>
							</tr>
							<tr>
								<td>
									<ul class="nav nav-tabs">
										#foreach($month in ${tc.months})
										#set($monthDate = $utilDate.dateToString($month.date,"yyyy-MM-dd"))
										<li class="tab-page tc-${velocityCount}-month #if(${velocityCount}==1) active #end" rId="${month.date.getTime()}" id="tc_${velocityCount}_month_${month.date.getTime()}_tab" rDate="$!{monthDate}">
											<a href="#tc_${velocityCount}_month_${month.date.getTime()}" data-toggle="tab">$utilDate.dateToString($month.date,"yyyy-MM")</a>
										</li>
										#end
										<li>
											<button class="btn btn-primary batch-insert" tc-id="${velocityCount}">批量录入</button>
										</li>
									</ul>
									<div class="tab-content">
										#foreach($month in ${tc.months})
										<div class="tab-pane in #if(${velocityCount}==1) active #end" id="tc_${velocityCount}_month_${month.date.getTime()}">
											<table class="table">
												<tbody>
													#foreach($day in ${month.days})
														#set($dayDate = $utilDate.dateToString($day.date,"yyyy-MM-dd"))
    													#if((${velocityCount} - 1) % 2 == 0)
    														#set($tr = "open")
    													#end
    													#if((${velocityCount} - 1) % 2 == 1)
    														#set($tr = "close")
    													#end
    													#if($tr == "open")
    												<tr>
    													#end
														<td class="tc-${velocityCount}-month-${month.date.getTime()}-day" rId="${day.date.getTime()}" rDate="$!{dayDate}">
														<div>$utilDate.dateToString($day.date,"dd")  $utilDate.formatWeekOnly($day.date)</div>
														#foreach($block in ${day.blocks})
															<div class="input-group">
																<span class="input-group-addon" block-name="${block.name}">${block.name}：</span>
																<input type="text" class="form-control tc-${tcId}-item-${block.type}-1" block-type="${block.type}" id="tc_${tcId}_month_${month.date.getTime()}_day_${day.date.getTime()}_${block.type}_1" placeholder="请输入成人价" value="$!{block.price}">
																<span class="input-group-addon">库存：</span>
																<input type="text" class="form-control tc-${tcId}-item-${block.type}-2" block-type="${block.type}" id="tc_${tcId}_month_${month.date.getTime()}_day_${day.date.getTime()}_${block.type}_2" placeholder="请输入库存" value="$!{block.stock}">
																<span class="input-group-addon">会员优惠：</span>
																<input type="text" class="form-control tc-${tcId}-item-${block.type}-3" block-type="${block.type}" id="tc_${tcId}_month_${month.date.getTime()}_day_${day.date.getTime()}_${block.type}_3" placeholder="请输入会员优惠" value="$!{block.discount}">
															</div>
														#end
														</td>
    													#if($tr == "close")
    												</tr>
    													#end
													#end
    												#if($tr == "open")
    												</tr>
    												#end
												</tbody>
											</table>
										</div>
										#end
									</div>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
				#end
            </div> 
		</div>
    </div>
	<div>
		<div>提前报名天数：</div>
		<div>
			<input type="text" class="form-control day-limit" value="$!{product.priceInfo.limit}">
		</div>
    </div>
</div>
<script type="text/javascript">
	// 日期输入框初始化
	$(".form-date").datetimepicker(
            {
                language:  "zh-CN",
                weekStart: 1,
                todayBtn:  1,
                autoclose: 1,
                todayHighlight: 1,
                startView: 2,
                minView: 2,
                forceParse: 0,
                format: "yyyy-mm-dd"
            });
	$(".form-datetime").datetimepicker(
			{
				language:  "zh-CN",
                weekStart: 1,
                todayBtn:  1,
                autoclose: 1,
                todayHighlight: 1,
                startView: 2,
                forceParse: 0,
                showMeridian: 1,
                format: "yyyy-mm-dd hh:ii"
            });
	var WEEK = {
		0:"周日",
		1:"周一",
		2:"周二",
		3:"周三",
		4:"周四",
		5:"周五",
		6:"周六"
	};
	$(".tc-del").click(removeTc);
	// 确认
	$(".setTime").click(function(){
		// check
		var startTime = $("#startTime").val()||"";
		if(startTime == "") {
			alert("请输入开始时间！");
			return;
		}
		var endTime = $("#endTime").val()||"";
		if(endTime == "") {
			alert("请输入结束时间！");
			return;
		}
		if(Date.parse(startTime) > Date.parse(endTime)){
			alert("开始时间不可大于结束时间！");
			return;
		}
		// time disable
		$("#startTime").addClass("disabled");
		$("#endTime").addClass("disabled");
		$(this).hide();
		$(".tc-main").show();
	});
	// 重置
	function resetTime(){
		// time avalible
		$("#tc_tab").empty();
		$("#tc_page").empty();
		$(".tc-main").hide();
		$(".setTime").show();
	}
	$(".form-date").change(resetTime);
	function removeTc() {
		var id = $(this).attr("tc-id");
		var prev = $("#tc_"+id+"_tab").prev();
		var next = $("#tc_"+id+"_tab").next();
		if(prev.length != 0) {
			prev.children("a").click();
		} else if(next.length != 0) {
			next.children("a").click();
		}
		$("#tc_"+id+"_tab").remove();
		$("#tc_"+id).remove();
	}
	
	$(".addTC").click(function(){
		curTcId = curTcId + 1;
		var tcTab = createTcTab(curTcId);
		$("#tc_tab").append(tcTab);
		var startDate = new Date($("#startTime").val());
		var endDate = new Date($("#endTime").val());
		var tcTabContent = createTcContent(curTcId,startDate,endDate);
		$("#tc_page").append(tcTabContent);
		$("#tc_"+curTcId).find(".tab-page a").eq(0).click();
		$("#tc_tab_"+curTcId+"_a").click();
	})
	$(".batch-insert").click(batchInsert);
	// 初始化
	var curTcId;
	$(function() {
		curTcId = $("#tc_tab li").length;
	});
	function createTcTab(id) {
		var tcTab = $("<li class='tab-page tc-tab' rId='"+id+"' id='tc_"+id+"_tab'/>");
		var tabA = $("<a href='#tc_"+id+"' data-toggle='tab' id='tc_tab_"+id+"_a'>套餐"+id+"&nbsp;&nbsp;</a>");
		var remove = $("<i class='icon icon-remove tc-del' tc-id='"+id+"'/>");
		remove.click(removeTc);
		return tcTab.append(tabA).append(remove);
	}
	function createTcContent(id,startDate,endDate) {
		var pane = $("<div class='tab-pane in' id='tc_"+id+"'/>")
		pane.append($("<input type='hidden' id='tc_"+id+"_startTime' value='"+CalendarUtils.getFormat(startDate,"yyyy-MM-dd")+"'>"));
		pane.append($("<input type='hidden' id='tc_"+id+"_endTime' value='"+CalendarUtils.getFormat(endDate,"yyyy-MM-dd")+"'>"));
		var table = $("<table class='table'/>");
		var td = $("<td/>");
		var tcName = $("<div>套餐名称：*<input type='text' id='tc_"+id+"_name' class='form-control' placeholder='请输入套餐名称'></div>")
		td.append(tcName);
		table.append($("<tr/>").append(td));
		var dateJson = CalendarUtils.getMonthTree(startDate,endDate);
		var dateTab = createDateTab(id,dateJson);
		var dateTabContent = createDateContent(id,dateJson);
		pane.append(table.append($("<tr/>").append($("<td/>").append(dateTab).append(dateTabContent))));
		return pane;
	}
	function createDateTab(id,dateJson) {
		var tab = $("<ul class='nav nav-tabs'/>");
		for(var i in dateJson) {
			var date = new Date(parseInt(i));
			var tcTab = $("<li class='tab-page tc-"+id+"-month' rId='"+i+"' id='tc_"+id+"_month_"+i+"_tab' rDate='"+CalendarUtils.getFormat(date,"yyyy-MM-dd")+"'/>");
			var month = CalendarUtils.getFormat(new Date(parseInt(i)),"yyyy年MM月");
			var tabA = $("<a href='#tc_"+id+"_month_"+i+"' data-toggle='tab'>"+month+"</a>");
			tab.append(tcTab.append(tabA));
		}
		var batch = $("<button class='btn btn-primary batch-insert' tc-id='"+id+"'>批量录入</button>");
		batch.click(batchInsert);
		//特效
		tab.append($("<li>").append(batch));
		return tab;
	}
	function createDateContent(id,dateJson) {
		var content = $("<div class='tab-content'/>");
		for(i in dateJson) {
			var tcTab = $("<div class='tab-pane in' id='tc_"+id+"_month_"+i+"'/>");
			var table = $("<table class='table'/>");
			var list = dateJson[i];
			var tr;
			for(j in list) {
				if(j % 2 == 0) {
					tr = $("<tr/>");
					table.append(tr);
				}
				var time = new Date(list[j]);
				var d =  CalendarUtils.getFormat(time ,"dd日 " + WEEK[time.getDay()]);
				// 扩展点
				var td = $("<td class='tc-"+id+"-month-"+i+"-day' rId='"+list[j]+"' rDate='"+CalendarUtils.getFormat(time ,"yyyy-MM-dd")+"'></td>");
				var day_id = "tc_"+id+"_month_"+i+"_day_"+list[j];
				var div_date = $("<div>"+d+"</div>");
				td.append(div_date);
				#foreach($linePropertyType in $linePropertyTypes)
				var group_${linePropertyType.id} = $("<div class='input-group'/>")
				group_${linePropertyType.id}.append("<span class='input-group-addon' block-name='${linePropertyType.name}'>${linePropertyType.name}：</span>");
				group_${linePropertyType.id}.append("<input type='text' class='form-control tc-"+id+"-item-${linePropertyType.id}-1' id='"+day_id+"_${linePropertyType.id}_1' placeholder='请输入成人价'>"); 
				group_${linePropertyType.id}.append("<span class='input-group-addon'>库存：</span>");
				group_${linePropertyType.id}.append("<input type='text' class='form-control tc-"+id+"-item-${linePropertyType.id}-2' id='"+day_id+"_${linePropertyType.id}_2' placeholder='请输入库存'>"); 
				group_${linePropertyType.id}.append("<span class='input-group-addon'>会员优惠：</span>");
				group_${linePropertyType.id}.append("<input type='text' class='form-control tc-"+id+"-item-${linePropertyType.id}-3' id='"+day_id+"_${linePropertyType.id}_3' placeholder='请输入会员优惠'>"); 
				td.append(group_${linePropertyType.id});
				#end
				tr.append(td);
			}
			content.append(tcTab.append(table));
		}
		return content;
	}
	
	var currentTcId;
    // 选择交通
	function batchInsert(){
		var currentTcId = $(this).attr("tc-id");
		openModalForForm(actionDefaultPath + '/B2C/comm/groupTravel/batchInsert?categoryId=${categoryId}','批量录入 ',function() {
			var data = win.getData();
			for(var i in data) {
				var block = data[i];
    			$(".tc-"+currentTcId+"-item-"+block.type+"-1").val(block.price);
    			$(".tc-"+currentTcId+"-item-"+block.type+"-2").val(block.stock);
    			$(".tc-"+currentTcId+"-item-"+block.type+"-3").val(block.discount);
			}
			// console.log(JSON.stringify(data));
			// 一般设定yes回调，必须进行手工关闭
			return true;
		});
    }
	
	// 获取价格信息
	function getPriceInfo() {
		var tcs = [];
		$(".tc-tab").each(function(){
			var tcId = $(this).attr("rId");
			var months = [];
			$(".tc-"+tcId+"-month").each(function(){
				var mId = $(this).attr("rId");
				var mDate = $(this).attr("rDate");
				var days = [];
				$(".tc-"+tcId+"-month-"+mId+"-day").each(function(){
					var dId = $(this).attr("rId");
					var dDate = $(this).attr("rDate");
					var day_id = "tc_"+tcId+"_month_"+mId+"_day_"+dId;
					var adult = {
						price:$("#"+day_id+"_11").val(),
						stock:$("#"+day_id+"_12").val(),
						discount:$("#"+day_id+"_13").val()
					};
					var children_0_2 = {
						price:$("#"+day_id+"_21").val(),
						stock:$("#"+day_id+"_22").val(),
						discount:$("#"+day_id+"_23").val()
					};
					var children_2_12 = {
						price:$("#"+day_id+"_31").val(),
						stock:$("#"+day_id+"_32").val(),
						discount:$("#"+day_id+"_33").val()
					};
					var srd = $("#"+day_id+"_41").val();
					days.push({
						date:dDate,
						adult:adult,
						children02:children_0_2,
						children212:children_2_12,
						srd:srd
					});
				});
				months.push({date:mDate,days:days});
			});
			tcs.push({
				id:tcId,
				startDate:$("#tc_"+tcId+"_startTime").val(),
				endDate:$("#tc_"+tcId+"_endTime").val(),
				name:$("#tc_"+tcId+"_name").val(),
				months:months
			});
		});
		return {tcs:tcs,limit:$(".day-limit").val()};
	}
</script>