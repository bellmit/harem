<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>景点列表</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link href="http://console.test.jiuxiulvxing.com/palace-web/resources/zui/css/zui.min.css?version=21" rel="stylesheet">
    <link rel="stylesheet" href="http://console.test.jiuxiulvxing.com/palace-web/resources/css/common.css?version=21" />
    <script src="http://console.test.jiuxiulvxing.com/palace-web/resources/js/jquery.js?version=21"></script>
    <script src="http://console.test.jiuxiulvxing.com/palace-web/resources/zui/js/zui.min.js?version=21"></script>
    <script src="http://console.test.jiuxiulvxing.com/palace-web/resources/js/respond.js?version=21"></script>
    <script src="http://console.test.jiuxiulvxing.com/palace-web/resources/js/common.js?version=21"></script>
    <script src="http://console.test.jiuxiulvxing.com/palace-web/resources/layer-v2.1/layer.js?version=21"></script>
    <script src="http://console.test.jiuxiulvxing.com/palace-web/resources/js/jquery-form.js?version=21" type="text/javascript"></script>
    <script src="http://console.test.jiuxiulvxing.com/palace-web/resources/js/jquery.validate.min.js?version=21"></script>
    <script src="http://console.test.jiuxiulvxing.com/palace-web/resources/js/JQ_verify.js?version=21"></script>
    <script src="http://console.test.jiuxiulvxing.com/palace-web/resources/js/jquery.metadata.js?version=21"></script>
    <script src="http://console.test.jiuxiulvxing.com/palace-web/resources/js/jquery.validform.js?version=21"></script>
    <script src="http://console.test.jiuxiulvxing.com/palace-web/resources/validate/messages_zh.min.js?version=21" type="text/javascript"></script>
    <style type="text/css">
        .table>thead th,
        .table>tbody td {
            text-align: center;
            vertical-align: middle;
        }
        .btnBottomMargin{
            margin-top: 10px;
        }

        .line-editor {
            width: 320px;
            padding: 10px;
            margin: 0 auto;
        }

        .line-editor .line {
            position: relative;
            width: 300px;
            padding: 10px;
            margin-top: 50px;
            background: #ddd;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .line .line-info {
            width: 100%;
            text-align: center;
        }

        .line .form-control {
            display: inline-block;
        }

        .line input {
            width: 100px;
            margin-right: 10px;
        }

        .line select {
            width: 150px;
        }

        .line .arrow {
            position: absolute;
            top: -45px;
            left: 50%;
            margin-left: -5px;
            width: 8px;
            height: 30px;
            background: #999;
        }

        .line .arrow>em {
            position: absolute;
            content: '';
            left: -50%;
            bottom: -12px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 12px solid #999;
        }

        .line.start {
            margin-top: 0;
        }

        .line.start .arrow {
            display: none;
        }
    </style>
</head>

<body>
<form id="form1" name="form1">
    <input type="hidden" id="hdnGuideId" value="$!{attractionId}">
    <input type="hidden" id="hdnScenicId" value="$!{scenicId}">
    <ul id="myTab" class="nav nav-tabs">
        <li class="active" data-target="#spotList">
            <a >景点详情</a>
        </li>
        <li data-target="#lineSetting">
            <a>线路设置</a>
        </li>
    </ul>
    <div class="tab-content">
        <div class="tab-pane active" id="spotList">
            <div class="btnBottomMargin">
                <a type="button" class="btn btn-primary addTourist" >添加景点</a>
            </div>
            <div class="tableGroup whole">
                <table class="table table-bordered table-hover" id="tbTourList">
                    <thead>
                    <tr>
                        <th>景点编号</th>
                        <th>景点名称</th>
                        <th>景点图</th>
                        <th>语音数量</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody>

                        #foreach($attractionCascadeFocusDTO in $touristlist)
                        <tr>
                            <td>$!attractionCascadeFocusDTO.guideAttractionDO.id</td>
                            <td>
                                $!attractionCascadeFocusDTO.guideAttractionDO.name
                            </td>
                            <td>
                                <img src="$!utilWebconfig.getTfsRootPath()$!{attractionCascadeFocusDTO.guideAttractionDO.attrImg}" width="150" height="90">
                            </td>
                            <td>
                                $!attractionCascadeFocusDTO.focusDOList.size()
                            </td>
                            <td>
                                <button type="button" class="btn btn-primary edit"  guideId="$!attractionCascadeFocusDTO.guideAttractionDO.guideId" id="$!attractionCascadeFocusDTO.guideAttractionDO.id">编辑</button>
                                <button type="button" class="btn btn-primary delete"  guideId="$!attractionCascadeFocusDTO.guideAttractionDO.guideId" id="$!attractionCascadeFocusDTO.guideAttractionDO.id">删除</button>
                            </td>
                        </tr>
                        #end

                    </tbody>
                </table>
            </div>
        </div>
        <div class="tab-pane" id="lineSetting">
            <table class="table" style="width:60%;margin:0 auto;">
                <tr>
                    <td style="text-align:center;">
                        <button id="addPoint" type="button" class="btn btn-primary" style="margin-right:30px">添加节点</button>
                        <button id="deletePoint" type="button" class="btn btn-primary" style="margin-right:30px">删除节点</button>
                        <button id="saveLine" type="button" class="btn btn-primary">保存线路</button>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div id="lineEditor" class="line-editor">
                        </div>
                    </td>
                </tr>
            </table>
        </div>
    </div>
</form>
<script type="text/javascript">
    function LineEditor(options) {
        var opts = options || {};
        this.lineData = opts.lineData || [];
        this.lineSettings = opts.lineSettings || [];
        this.init();
    }
    LineEditor.prototype = {
        constructor: LineEditor,
        init: function() {
            this.render();
            this.attachEvent();
        },
        selectors: {
            addPoint: "#addPoint",
            deletePoint: "#deletePoint",
            lineEditor: "#lineEditor",
            saveLine:"#saveLine",
            line: ".line"
        },
        render: function() {
            var self = this;
            var editor = $(self.selectors.lineEditor);
            if (self.lineSettings.length == 0) {
                editor.append(self.getLineHtml(true));
            } else {
                $.each(self.lineSettings, function(index, line) {
                    editor.append(self.getLineHtml(index == 0, line.tourid, line.time));
                });
            }
        },
        attachEvent: function() {
            var self = this;
            //添加节点
            $(self.selectors.addPoint).on("click", function() {
                var lineHtml = self.getLineHtml(false);
                $(self.selectors.lineEditor).append(lineHtml);
            });
            //删除节点
            $(self.selectors.deletePoint).on("click", function() {
                var lastItem = $(self.selectors.line + ":last", self.selectors.lineEditor);
                if (lastItem.length == 0) {
                    return;
                }
                if (lastItem.hasClass("start")) {
                    return;
                }
                lastItem.remove();
            });

            //保存节点
            $(self.selectors.saveLine).on("click",function(){
                if(!self.isValid()){
                    layer.msg("请先设置线路",{icon:2,time:1500});
                    return;
                }
                self.saveLine();

            });
        },
        saveLine:function(){
            var self=this;
            var data={guideId:self.guideId,lines:self.getLineSettings};
            $.ajax({
                url:"$utilWebconfig.getStaticResourcesPath()/jiuxiu/scenicManage/updateGuideLine",
                type:"post",
                data:data,
                dataType:"json",
                success:function(res){
                    if(res.status==200){
                       layer.msg("保存成功",{icon:1,time:1500});
                    }
                    else{
                        layer.msg("保存失败!",{icon:2,time:1500});
                    }
                },
                error:function(){
                    layer.msg("保存失败!",{icon:2,time:1500});
                }
            });
        },
        getLineHtml: function(start, tourid, time) {
            var temp = [];
            var length = this.lineData.length;
            var startCss = start ? "start" : "";
            var timeStr = time || '';
            temp.push('<div class="line ' + startCss + '">');
            temp.push('<div class="line-info">')
            if (!start) {
                temp.push('<input class="form-control" value="' + timeStr + '" />');
            }
            temp.push('<select class="form-control">');
            for (var index = 0; index < length; index++) {
                if (this.lineData[index].value == tourid) {
                    temp.push('<option selected value="' + this.lineData[index].value + '">' + this.lineData[index].name + '</option>');
                } else {
                    temp.push('<option value="' + this.lineData[index].value + '">' + this.lineData[index].name + '</option>');
                }
            }
            temp.push('</select>');
            temp.push('</div>');
            temp.push('<i class="arrow"><em></em></i>');
            temp.push('</div>');

            return temp.join('');
        },
        getLineSettings: function() {
            var data = [];
            $(this.selectors.line).each(function(index, _line) {
                var line = $(_line);
                if (index == 0) {
                    data.push({
                        tourid: line.find("select").val()
                    });
                } else {
                    data.push({
                        tourid: line.find("select").val(),
                        time: line.find("input").val()
                    });
                }
            });
            return data;
        },
        isValid:function () {
            return $(this.selectors.line).length>1;
        }
    };

</script>


<script type="text/javascript">
    // 新增景点
    var lineEditor=null;
    $(function(){
        var guideId=$("#hdnGuideId").val();
        $(".addTourist").click(function(){
            window.parent.tabsAdd('',"$utilWebconfig.getStaticResourcesPath()/jiuxiu/scenicManage/touristaddDetail?attractionId="+guideId,2,"景点详情");
        });

        //  编辑景点
        $("#tbTourList").on("click",".edit",function(){
            var id = $(this).attr("id");
            var guideId=$(this).attr("guideId")
            window.parent.tabsAdd('', "$utilWebconfig.getStaticResourcesPath()/jiuxiu/scenicManage/touristEditDetail?attractionId="+id+"&guideId="+guideId, 2, "景点详情");
            window.parent.tabsAdd('', "$utilWebconfig.getStaticResourcesPath()/jiuxiu/scenicManage/touristEditDetail?id="+guideId +"&guideId="+guideId, 2, "景点详情");
        });

        //删除景点
        $("#tbTourList").on("click",".delete",function(){
            var id = $(this).attr("id");
            var guideId=$(this).attr("guideId");
            getTourStatus(guideId,id);
        });

        //切换到线路页面
        $("#myTab li").on("click", function() {
            var target = $(this).data("target");
            $("#myTab li").removeClass("active");
            $(".tab-content .tab-pane").removeClass("active")

            $(this).addClass("active");
            $(target).addClass("active");
            if (target == "#lineSetting") {
                //重新初始化线路
                initLineEditor();
            }
        });
    });


    function initLineEditor(){
        var scenicId=$("#hdnScenicId").val();
        $.ajax({
            url:"$utilWebconfig.getStaticResourcesPath()/jiuxiu/scenicManage/queryGuideAttractionFocusInfo",
            type:"get",
            data:{scenicId:scenicId},
            beforeSend:function(){
                layer.msg("正在获取线路设置...",{icon:16,time:null});
            },
            success:function(res){
                layer.closeAll();
                if(res.status==200){
                    if(lineEditor){
//                      lineEditor.lineData=res.data.lineData;
//                      lineEditor.lineSettings=res.data.lineSettings;
                        lineEditor.lineData=res.data.attractionDTOList;
                        lineEditor.lineSettings=res.data.guideLineDTO.guideLine;
                        lineEditor.render();
                    }else{
                        lineEditor=new LineEditor({
                            lineData:res.data.lineData,
                            lineSettings:res.data.lineSettings
                        });
                    }
                }
                else{
                    layer.msg("获取线路设置失败!",{icon:2,time:1500});
                }
            },
            error:function(){
                layer.msg("获取线路设置失败!",{icon:2,time:1500});
            }
        });
    }
    function getTourStatus(guideId,id){
        var data={guideId:guideId,id:id};
        $.ajax({
            url:"$utilWebconfig.getStaticResourcesPath()/jiuxiu/scenicManage/queryGuideLine",
            type:"get",
            data:data,
            success:function(res){
                if(res.success){
                    msg=getTips(res.value);
                    layer.confirm(msg,function(){
                        deleteTour(id);
                    });
                }
                else{
                    layer.msg("删除失败!",{icon:2,time:1500});
                }
            },
            error:function(){
                layer.msg("删除失败!",{icon:2,time:1500});
            }
        });
    }

    function getTips(status){
        var message={
            "0":"是否确认删除？",
            "1":"删除此景点信息将影响线路设置，是否确认删除？",
            "2":"删除此景点信息需重新配置线路，是否确认删除？"
        };

        var msg=message[status];
        if(msg){
            return msg;
        }
        return message["1"];
    }

    function deleteTour(id){
        $.ajax({
            url:"$utilWebconfig.getStaticResourcesPath()/jiuxiu/scenicManage/deleteAttraction",
            type:"post",
            data:{id:id},
            dataType:"json",
            success:function(data){
                if(data.status==200){
                    layer.msg("删除成功!",{icon:1,time:1500});
                    setTimeout(function(){
                        window.location.reload();
                    },2000)
                }else{
                    layer.msg("删除失败!",{icon:1,time:1500});
                }
            },
            error:function(){
                layer.msg("删除失败!",{icon:1,time:1500});
            }
        })
    }
</script>

</body>

</html>


